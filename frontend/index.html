<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FAKE DATA PREVENTION — Security Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg:#0a0a0a;--bg2:#111;--bg3:#161616;--bg4:#1c1c1c;
      --border:#222;--border2:#2a2a2a;
      --yellow:#e8ff00;--yellow2:#b8cc00;--yellow-dim:#4a5500;
      --red:#ff2d2d;--red-dim:#3a0000;--red2:#cc0000;
      --green:#00ff88;--green-dim:#003322;--green2:#00cc66;
      --blue:#00cfff;--blue-dim:#003344;
      --purple:#9b59ff;--purple-dim:#1e0044;
      --text:#e0e0e0;--text2:#888;--text3:#555;
      --mono:'Share Tech Mono',monospace;
      --display:'Bebas Neue',impact,sans-serif;
      --sans:'DM Sans',system-ui,sans-serif;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{
      background:var(--bg);color:var(--text);font-family:var(--sans);font-weight:300;
      min-height:100vh;-webkit-font-smoothing:antialiased;
      background-image:
        linear-gradient(rgba(232,255,0,.015) 1px,transparent 1px),
        linear-gradient(90deg,rgba(232,255,0,.015) 1px,transparent 1px);
      background-size:40px 40px;
    }

    /* ── SCANLINE OVERLAY ── */
    body::before{
      content:'';position:fixed;inset:0;pointer-events:none;z-index:1000;
      background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.08) 2px,rgba(0,0,0,.08) 4px);
    }

    /* ── HEADER ── */
    header{
      border-bottom:1px solid var(--border2);padding:.9rem 2.5rem;
      display:flex;align-items:center;justify-content:space-between;
      background:rgba(10,10,10,.95);position:sticky;top:0;z-index:200;
      backdrop-filter:blur(8px);
    }
    .logo{font-family:var(--display);font-size:1.4rem;letter-spacing:.12em;color:var(--yellow);
      text-shadow:0 0 20px rgba(232,255,0,.4)}
    .header-right{display:flex;align-items:center;gap:1.5rem}
    .nav-tag{font-family:var(--mono);font-size:.62rem;color:var(--text3);letter-spacing:.08em}
    .status-dot{display:flex;align-items:center;gap:.4rem;font-family:var(--mono);font-size:.6rem;color:var(--green)}
    .status-dot::before{content:'';width:6px;height:6px;background:var(--green);border-radius:50%;
      animation:pulse-green 2s infinite;box-shadow:0 0 6px var(--green)}
    @keyframes pulse-green{0%,100%{opacity:1}50%{opacity:.4}}

    /* ── TABS ── */
    .tabs-bar{
      border-bottom:1px solid var(--border2);display:flex;
      background:var(--bg2);position:sticky;top:53px;z-index:100;
    }
    .tab{
      padding:.75rem 2rem;font-family:var(--mono);font-size:.65rem;letter-spacing:.12em;
      text-transform:uppercase;color:var(--text3);cursor:pointer;
      border-bottom:2px solid transparent;border:none;background:none;
      border-bottom:2px solid transparent;transition:all .2s;
      position:relative;
    }
    .tab::after{content:attr(data-n);position:absolute;top:.4rem;right:.6rem;
      font-size:.48rem;color:var(--text3);letter-spacing:.06em}
    .tab:hover{color:var(--text);background:var(--bg3)}
    .tab.active{color:var(--yellow);border-bottom-color:var(--yellow);background:var(--bg3);
      text-shadow:0 0 12px rgba(232,255,0,.3)}

    /* ── PANELS ── */
    .panel{display:none}.panel.active{display:block}

    /* ── SHARED ── */
    .eyebrow{font-family:var(--mono);font-size:.6rem;color:var(--yellow);letter-spacing:.15em;
      text-transform:uppercase;margin-bottom:1rem;display:flex;align-items:center;gap:.6rem}
    .eyebrow::before{content:'//';color:var(--text3)}
    .section-label{
      font-family:var(--mono);font-size:.58rem;color:var(--text3);letter-spacing:.1em;
      text-transform:uppercase;padding-bottom:.9rem;margin-bottom:1.5rem;
      border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;
    }
    .section-label span:last-child{color:var(--yellow);font-size:.55rem}

    /* ═══════════════════════════════════
       TAB 1 — OVERVIEW
    ═══════════════════════════════════ */
    .hero{
      padding:4rem 2.5rem 3rem;border-bottom:1px solid var(--border);
      display:grid;grid-template-columns:1fr 1fr;gap:5rem;align-items:start;
    }
    h1{
      font-family:var(--display);font-size:clamp(3rem,5vw,5.5rem);
      font-weight:400;line-height:.95;letter-spacing:.04em;color:var(--text);
      margin-bottom:1.2rem;
    }
    h1 span{color:var(--yellow);text-shadow:0 0 30px rgba(232,255,0,.5)}
    .hero-desc{font-size:.85rem;color:var(--text2);line-height:1.8;margin-bottom:1.75rem;max-width:44ch}
    .meta-row{display:flex;justify-content:space-between;padding:.5rem 0;
      border-bottom:1px solid var(--border);font-size:.78rem}
    .meta-row .k{font-family:var(--mono);color:var(--text3);font-size:.62rem;text-transform:uppercase;letter-spacing:.06em}
    .meta-row .v{font-family:var(--mono);font-size:.72rem;color:var(--yellow)}

    /* Ring */
    .ring-section{
      display:flex;justify-content:center;align-items:center;gap:5rem;
      padding:3rem 2.5rem;border-bottom:1px solid var(--border);
    }
    .ring-wrap{position:relative;width:260px;height:260px;flex-shrink:0}
    .ring-svg{width:100%;height:100%;animation:spin 60s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .ring-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
    .ring-pct{font-family:var(--display);font-size:3.8rem;color:var(--yellow);
      text-shadow:0 0 30px rgba(232,255,0,.5);line-height:1}
    .ring-lbl{font-family:var(--mono);font-size:.58rem;color:var(--text3);letter-spacing:.12em;text-transform:uppercase;margin-top:.4rem}
    .ring-aside{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;flex:1}
    .aside-item{padding:1.2rem;background:var(--bg2);border:1px solid var(--border)}
    .aside-n{font-family:var(--display);font-size:2.8rem;line-height:1;margin-bottom:.3rem}
    .aside-n.yellow{color:var(--yellow);text-shadow:0 0 16px rgba(232,255,0,.3)}
    .aside-n.red{color:var(--red);text-shadow:0 0 16px rgba(255,45,45,.3)}
    .aside-n.green{color:var(--green);text-shadow:0 0 16px rgba(0,255,136,.3)}
    .aside-l{font-family:var(--mono);font-size:.58rem;color:var(--text3);letter-spacing:.08em;text-transform:uppercase}

    /* KPI strip */
    .kpi-strip{display:grid;grid-template-columns:repeat(5,1fr);border-bottom:1px solid var(--border)}
    .kpi-cell{padding:2rem 1.5rem;border-right:1px solid var(--border);transition:background .2s;cursor:default;position:relative;overflow:hidden}
    .kpi-cell::before{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;opacity:0;transition:opacity .3s}
    .kpi-cell:hover{background:var(--bg2)}.kpi-cell:hover::before{opacity:1}
    .kpi-cell:last-child{border-right:none}
    .kpi-cell.valid::before{background:var(--green)}
    .kpi-cell.mod::before{background:var(--yellow)}
    .kpi-cell.fab::before{background:var(--red)}
    .kpi-cell.rep::before{background:var(--purple)}
    .kpi-lbl{font-family:var(--mono);font-size:.58rem;color:var(--text3);letter-spacing:.08em;text-transform:uppercase;margin-bottom:.5rem}
    .kpi-n{font-family:var(--display);font-size:3rem;font-weight:400;line-height:1;margin-bottom:.3rem}
    .kpi-d{font-family:var(--mono);font-size:.6rem;color:var(--text3)}
    .kpi-cell.total .kpi-n{color:var(--text)}
    .kpi-cell.valid .kpi-n{color:var(--green);text-shadow:0 0 16px rgba(0,255,136,.3)}
    .kpi-cell.mod .kpi-n{color:var(--yellow);text-shadow:0 0 16px rgba(232,255,0,.3)}
    .kpi-cell.fab .kpi-n{color:var(--red);text-shadow:0 0 16px rgba(255,45,45,.3)}
    .kpi-cell.rep .kpi-n{color:var(--purple);text-shadow:0 0 16px rgba(155,89,255,.3)}

    /* Two-col */
    .two-col{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border)}
    .col{padding:2.5rem;border-right:1px solid var(--border)}.col:last-child{border-right:none}

    /* Attacks */
    .attack{padding:1.25rem 0;border-bottom:1px solid var(--border)}
    .attack:last-child{border-bottom:none}
    .attack-hdr{display:flex;align-items:center;gap:.8rem;margin-bottom:.6rem}
    .attack-idx{font-family:var(--mono);font-size:.58rem;color:var(--text3)}
    .attack-name{font-family:var(--display);font-size:1.4rem;letter-spacing:.06em}
    .attack-tag{margin-left:auto;font-family:var(--mono);font-size:.55rem;letter-spacing:.1em;padding:.12rem .5rem;border:1px solid}
    .attack-tag.fab{color:var(--red);border-color:var(--red2);background:var(--red-dim)}
    .attack-tag.mod{color:var(--yellow);border-color:var(--yellow2);background:var(--yellow-dim)}
    .attack-tag.rep{color:var(--purple);border-color:var(--purple);background:var(--purple-dim)}
    .attack-desc{font-size:.78rem;color:var(--text2);line-height:1.7;margin-bottom:.5rem}
    .attack-det{font-family:var(--mono);font-size:.62rem;color:var(--green)}
    .attack-det::before{content:'> '}

    /* Flow */
    .flow-item{display:grid;grid-template-columns:2rem 1fr;gap:.7rem;padding:.85rem 0;border-bottom:1px solid var(--border);align-items:start}
    .flow-item:last-child{border-bottom:none}
    .flow-n{font-family:var(--mono);font-size:.58rem;color:var(--text3);padding-top:.1rem}
    .flow-title{font-family:var(--mono);font-size:.78rem;color:var(--yellow);margin-bottom:.12rem}
    .flow-desc{font-size:.73rem;color:var(--text2);line-height:1.55}
    .flow-tool{display:inline-block;margin-top:.25rem;font-family:var(--mono);font-size:.55rem;
      color:var(--blue);border:1px solid var(--blue-dim);padding:.05rem .35rem;background:var(--blue-dim)}

    /* Tools */
    .tools-section{padding:2.5rem;border-bottom:1px solid var(--border)}
    .tools-grid{display:grid;grid-template-columns:repeat(4,1fr);border:1px solid var(--border);margin-top:1.5rem}
    .tool{padding:1.75rem 1.4rem;border-right:1px solid var(--border);transition:background .2s;position:relative}
    .tool:last-child{border-right:none}.tool:hover{background:var(--bg2)}
    .tool-num{font-family:var(--mono);font-size:.55rem;color:var(--text3);letter-spacing:.1em;margin-bottom:1rem}
    .tool-name{font-family:var(--display);font-size:1.2rem;letter-spacing:.04em;color:var(--text);margin-bottom:.6rem;line-height:1.2}
    .tool-desc{font-size:.73rem;color:var(--text2);line-height:1.65;margin-bottom:.8rem}
    .tool-goal{font-family:var(--mono);font-size:.6rem;color:var(--green)}
    .tool-goal::before{content:'→ '}

    /* ═══════════════════════════════════
       TAB 2 — TRANSACTION LOG
    ═══════════════════════════════════ */
    .log-hero{padding:3rem 2.5rem;border-bottom:1px solid var(--border);display:grid;grid-template-columns:1fr 1fr;gap:4rem;align-items:start}
    .log-desc{font-size:.83rem;color:var(--text2);line-height:1.8;max-width:44ch}
    .sec-strip{display:grid;grid-template-columns:repeat(4,1fr);border-bottom:1px solid var(--border)}
    .sec-cell{padding:1.5rem;border-right:1px solid var(--border);transition:background .2s}
    .sec-cell:last-child{border-right:none}.sec-cell:hover{background:var(--bg2)}
    .sec-icon{font-family:var(--mono);font-size:.55rem;color:var(--text3);letter-spacing:.1em;margin-bottom:.5rem}
    .sec-name{font-family:var(--mono);font-size:.75rem;color:var(--yellow);margin-bottom:.4rem}
    .sec-desc{font-size:.72rem;color:var(--text2);line-height:1.5}
    .sec-ok{font-family:var(--mono);font-size:.58rem;color:var(--green);margin-top:.5rem}
    .sec-fail{font-family:var(--mono);font-size:.58rem;color:var(--red);margin-top:.18rem}

    .glossary{padding:2.5rem;border-bottom:1px solid var(--border)}
    .fields-grid{display:grid;grid-template-columns:repeat(3,1fr);border:1px solid var(--border);margin-top:1.5rem}
    .field-card{padding:1.25rem;border-right:1px solid var(--border);border-bottom:1px solid var(--border);transition:background .2s}
    .field-card:hover{background:var(--bg2)}
    .field-card:nth-child(3n){border-right:none}.field-card:nth-last-child(-n+3){border-bottom:none}
    .field-name{font-family:var(--mono);font-size:.68rem;color:var(--yellow);margin-bottom:.35rem}
    .field-type{display:inline-block;font-family:var(--mono);font-size:.54rem;color:var(--text3);
      border:1px solid var(--border2);padding:.04rem .35rem;margin-bottom:.5rem;background:var(--bg3)}
    .field-desc{font-size:.73rem;color:var(--text2);line-height:1.6}
    .field-ex{font-family:var(--mono);font-size:.6rem;color:var(--text3);margin-top:.4rem;
      padding-top:.4rem;border-top:1px solid var(--border)}

    .tbl-controls{padding:1.4rem 2.5rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
    .filter-bar{display:flex;border:1px solid var(--border2)}
    .fbtn{padding:.3rem .8rem;border:none;border-right:1px solid var(--border2);background:transparent;
      font-family:var(--mono);font-size:.6rem;letter-spacing:.06em;text-transform:uppercase;
      color:var(--text3);cursor:pointer;transition:all .18s}
    .fbtn:last-child{border-right:none}.fbtn:hover{background:var(--bg3);color:var(--text)}
    .fbtn.active{background:var(--yellow);color:var(--bg)}
    .search-input{font-family:var(--mono);font-size:.68rem;border:1px solid var(--border2);
      background:transparent;padding:.32rem .85rem;color:var(--text);outline:none;width:200px}
    .search-input::placeholder{color:var(--text3)}.search-input:focus{border-color:var(--yellow)}
    .row-count{font-family:var(--mono);font-size:.6rem;color:var(--text3)}

    .log-table-wrap{padding:0 2.5rem 2.5rem;overflow-x:auto}
    table{width:100%;border-collapse:collapse}
    thead th{font-family:var(--mono);font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;
      color:var(--text3);text-align:left;padding:.7rem .9rem;border-bottom:1px solid var(--border2);
      background:var(--bg2);font-weight:400;white-space:nowrap}
    tbody tr.dr{border-bottom:1px solid var(--border);transition:background .12s;cursor:pointer}
    tbody tr.dr:hover{background:var(--bg2)}
    tbody td{padding:.65rem .9rem;font-size:.75rem;color:var(--text2)}
    .td-id{font-family:var(--mono);font-size:.63rem;color:var(--text3)}
    .td-ts{font-family:var(--mono);font-size:.62rem;color:var(--text3)}
    .td-amt{font-family:var(--mono);font-size:.7rem;color:var(--yellow);text-align:right}
    .stag{display:inline-block;font-family:var(--mono);font-size:.54rem;letter-spacing:.06em;padding:.07rem .45rem;border:1px solid;white-space:nowrap}
    .stag.ok{color:var(--green);border-color:var(--green2);background:var(--green-dim)}
    .stag.mod{color:var(--yellow);border-color:var(--yellow2);background:var(--yellow-dim)}
    .stag.fab{color:var(--red);border-color:var(--red2);background:var(--red-dim)}
    .stag.rep{color:var(--purple);border-color:var(--purple);background:var(--purple-dim)}
    .cat-tag{display:inline-block;font-family:var(--mono);font-size:.54rem;color:var(--text3);
      border:1px solid var(--border);padding:.04rem .35rem}
    .bok{color:var(--green);font-family:var(--mono);font-size:.68rem}
    .bno{color:var(--red);font-family:var(--mono);font-size:.68rem}
    .detail-row{display:none;background:var(--bg3)}.detail-row.open{display:table-row}
    .detail-cell{padding:1.25rem 2rem;border-bottom:1px solid var(--border)}
    .detail-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1.2rem}
    .df-key{font-family:var(--mono);font-size:.56rem;color:var(--text3);letter-spacing:.08em;text-transform:uppercase;margin-bottom:.22rem}
    .df-val{font-size:.75rem;color:var(--text);font-family:var(--mono);word-break:break-all}
    .detail-checks{margin-top:.9rem;display:flex;gap:.6rem;flex-wrap:wrap}
    .cpill{display:inline-flex;align-items:center;gap:.3rem;font-family:var(--mono);font-size:.6rem;padding:.18rem .6rem;border:1px solid}
    .cpill.pass{color:var(--green);border-color:var(--green2);background:var(--green-dim)}
    .cpill.fail{color:var(--red);border-color:var(--red2);background:var(--red-dim)}
    .err-msg{margin-top:.6rem;font-family:var(--mono);font-size:.63rem;color:var(--red);
      padding:.4rem .6rem;background:var(--red-dim);border-left:2px solid var(--red)}

    /* ═══════════════════════════════════
       TAB 3 — SIMULATOR
    ═══════════════════════════════════ */
    .sim-hero{padding:3.5rem 2.5rem 2.5rem;border-bottom:1px solid var(--border);
      display:grid;grid-template-columns:1fr 1fr;gap:5rem;align-items:start}
    .sim-desc{font-size:.84rem;color:var(--text2);line-height:1.8;margin-bottom:1.4rem;max-width:44ch}
    .step-pills{display:flex;gap:.4rem;flex-wrap:wrap}
    .step-pill{font-family:var(--mono);font-size:.58rem;color:var(--text3);
      border:1px solid var(--border);padding:.16rem .58rem;background:var(--bg2)}

    /* Upload */
    .upload-section{padding:2.5rem;border-bottom:1px solid var(--border)}
    .upload-zone{
      border:1px dashed var(--border2);padding:2.5rem 2rem;text-align:center;
      cursor:pointer;transition:all .2s;position:relative;background:var(--bg2);
    }
    .upload-zone:hover,.upload-zone.drag{border-color:var(--yellow);background:var(--bg3);
      box-shadow:inset 0 0 40px rgba(232,255,0,.04)}
    .upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
    .upload-icon{font-family:var(--mono);font-size:1.2rem;color:var(--text3);margin-bottom:.6rem}
    .upload-title{font-family:var(--display);font-size:1.6rem;letter-spacing:.06em;color:var(--text);margin-bottom:.3rem}
    .upload-sub{font-size:.76rem;color:var(--text3);margin-bottom:.5rem;font-family:var(--mono)}
    .upload-demo{font-family:var(--mono);font-size:.62rem;color:var(--text3)}
    .upload-demo span{cursor:pointer;color:var(--yellow);text-decoration:underline;
      text-underline-offset:3px;transition:text-shadow .2s}
    .upload-demo span:hover{text-shadow:0 0 10px rgba(232,255,0,.5)}

    /* Pipeline */
    .pipeline-bar{display:grid;grid-template-columns:repeat(5,1fr);border-bottom:1px solid var(--border)}
    .pipe-cell{padding:1.4rem;border-right:1px solid var(--border);position:relative;transition:background .2s}
    .pipe-cell:last-child{border-right:none}
    .pipe-n{font-family:var(--mono);font-size:.55rem;color:var(--text3);letter-spacing:.1em;margin-bottom:.45rem}
    .pipe-title{font-family:var(--mono);font-size:.75rem;color:var(--text);margin-bottom:.22rem}
    .pipe-desc{font-size:.68rem;color:var(--text3);line-height:1.45}
    .pipe-st{margin-top:.6rem;font-family:var(--mono);font-size:.6rem}
    .pipe-st.pending{color:var(--text3)}
    .pipe-st.running{color:var(--yellow);animation:blink 1s infinite}
    .pipe-st.done{color:var(--green)}
    .pipe-st.fail{color:var(--red)}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
    .pipe-prog{position:absolute;bottom:0;left:0;height:2px;background:var(--yellow);width:0;transition:width .35s;
      box-shadow:0 0 8px rgba(232,255,0,.5)}

    /* Stats */
    .sim-stats{display:grid;grid-template-columns:repeat(6,1fr);border-bottom:1px solid var(--border)}
    .sstat{padding:1.4rem 1.2rem;border-right:1px solid var(--border);transition:background .2s}
    .sstat:last-child{border-right:none}.sstat:hover{background:var(--bg2)}
    .sstat-n{font-family:var(--display);font-size:2.2rem;font-weight:400;line-height:1;margin-bottom:.25rem}
    .sstat-l{font-family:var(--mono);font-size:.57rem;color:var(--text3);letter-spacing:.07em;text-transform:uppercase}
    .sstat.s-total .sstat-n{color:var(--text)}
    .sstat.s-ok .sstat-n{color:var(--green);text-shadow:0 0 12px rgba(0,255,136,.3)}
    .sstat.s-mod .sstat-n{color:var(--yellow);text-shadow:0 0 12px rgba(232,255,0,.3)}
    .sstat.s-fab .sstat-n{color:var(--red);text-shadow:0 0 12px rgba(255,45,45,.3)}
    .sstat.s-rep .sstat-n{color:var(--purple);text-shadow:0 0 12px rgba(155,89,255,.3)}
    .sstat.s-time .sstat-n{color:var(--blue)}

    /* Sim table */
    .sim-table-wrap{padding:1.5rem 2.5rem;overflow-x:auto}
    .sim-tbl-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem}
    .sim-tbl-title{font-family:var(--display);font-size:1.5rem;letter-spacing:.06em}
    .btn-group{display:flex;gap:.6rem;align-items:center}
    .stress-btn{
      font-family:var(--mono);font-size:.6rem;letter-spacing:.06em;
      border:1px solid var(--red2);color:var(--red);padding:.3rem .85rem;
      cursor:pointer;background:transparent;transition:all .2s;
    }
    .stress-btn:hover:not(:disabled){background:var(--red);color:#fff;border-color:var(--red);
      box-shadow:0 0 16px rgba(255,45,45,.4)}
    .stress-btn:disabled{opacity:.3;cursor:not-allowed}
    .reset-btn{
      font-family:var(--mono);font-size:.6rem;letter-spacing:.06em;
      border:1px solid var(--border2);color:var(--text3);padding:.3rem .85rem;
      cursor:pointer;background:transparent;transition:all .2s;
    }
    .reset-btn:hover:not(:disabled){background:var(--bg3);color:var(--text)}
    .reset-btn:disabled{opacity:.3;cursor:not-allowed}

    .atk-btn{font-family:var(--mono);font-size:.54rem;letter-spacing:.05em;border:1px solid;
      padding:.12rem .44rem;cursor:pointer;background:transparent;transition:all .15s;margin-right:.2rem}
    .atk-btn.mod{color:var(--yellow);border-color:var(--yellow-dim)}
    .atk-btn.mod:hover:not(:disabled){background:var(--yellow);color:var(--bg)}
    .atk-btn.fab{color:var(--red);border-color:var(--red-dim)}
    .atk-btn.fab:hover:not(:disabled){background:var(--red);color:#fff}
    .atk-btn.rep{color:var(--purple);border-color:var(--purple-dim)}
    .atk-btn.rep:hover:not(:disabled){background:var(--purple);color:#fff}
    .atk-btn.rst{color:var(--text3);border-color:var(--border)}
    .atk-btn.rst:hover:not(:disabled){background:var(--bg3);color:var(--text)}
    .atk-btn:disabled{opacity:.25;cursor:not-allowed}

    .vstag{display:inline-block;font-family:var(--mono);font-size:.53rem;letter-spacing:.05em;padding:.07rem .42rem;border:1px solid}
    .vstag.ok{color:var(--green);border-color:var(--green2);background:var(--green-dim)}
    .vstag.pending{color:var(--text3);border-color:var(--border)}
    .vstag.fail-mod{color:var(--yellow);border-color:var(--yellow2);background:var(--yellow-dim)}
    .vstag.fail-fab{color:var(--red);border-color:var(--red2);background:var(--red-dim)}
    .vstag.fail-rep{color:var(--purple);border-color:var(--purple);background:var(--purple-dim)}
    .dig-short{font-family:var(--mono);font-size:.6rem;color:var(--text3);cursor:help}

    /* Live log */
    .live-log-section{padding:1.5rem 2.5rem;background:var(--bg2);border-top:1px solid var(--border)}
    .log-hdr{font-family:var(--mono);font-size:.6rem;color:var(--text3);letter-spacing:.1em;
      text-transform:uppercase;margin-bottom:.75rem;display:flex;justify-content:space-between;align-items:center}
    .log-hdr span{color:var(--yellow)}
    .log-clear-btn{background:none;border:1px solid var(--border);font-family:var(--mono);
      font-size:.56rem;color:var(--text3);padding:.1rem .42rem;cursor:pointer;letter-spacing:.06em}
    .log-clear-btn:hover{border-color:var(--yellow);color:var(--yellow)}
    #live-log{font-family:var(--mono);font-size:.67rem;line-height:1.75;max-height:220px;overflow-y:auto;color:var(--text2)}
    #live-log::-webkit-scrollbar{width:4px}#live-log::-webkit-scrollbar-track{background:var(--bg)}
    #live-log::-webkit-scrollbar-thumb{background:var(--border2)}
    .log-ok{color:var(--green)}.log-err{color:var(--red)}.log-warn{color:var(--yellow)}.log-info{color:var(--text3)}

    /* Empty */
    .empty{padding:4rem 3rem;text-align:center}
    .empty-icon{font-family:var(--mono);font-size:1.5rem;color:var(--text3);margin-bottom:.75rem}
    .empty-t{font-family:var(--display);font-size:1.4rem;color:var(--text3);margin-bottom:.35rem;letter-spacing:.06em}
    .empty-s{font-size:.78rem;color:var(--text3);font-family:var(--mono)}

    /* ── FOOTER ── */
    footer{padding:1.75rem 2.5rem;display:flex;justify-content:space-between;align-items:center;
      border-top:1px solid var(--border)}
    .foot-l{font-family:var(--display);font-size:1rem;letter-spacing:.08em;color:var(--text3)}
    .foot-r{font-family:var(--mono);font-size:.58rem;color:var(--text3);letter-spacing:.06em}

    /* Fade-in */
    .fade{opacity:0;transform:translateY(8px);animation:fi .5s ease forwards}
    @keyframes fi{to{opacity:1;transform:translateY(0)}}
    .fade:nth-child(1){animation-delay:.04s}.fade:nth-child(2){animation-delay:.1s}
    .fade:nth-child(3){animation-delay:.16s}.fade:nth-child(4){animation-delay:.22s}
    .fade:nth-child(5){animation-delay:.28s}

    @media(max-width:900px){
      .hero,.two-col,.sim-hero,.log-hero{grid-template-columns:1fr}
      .kpi-strip{grid-template-columns:repeat(3,1fr)}.tools-grid{grid-template-columns:repeat(2,1fr)}
      .sec-strip,.pipeline-bar,.sim-stats{grid-template-columns:repeat(2,1fr)}
      .ring-section{flex-direction:column}.ring-aside{grid-template-columns:repeat(4,1fr)}
      header{padding:.8rem 1.2rem}
    }
  </style>
</head>
<body>

<header>
  <div class="logo">FAKE·DATA·PREVENTION</div>
  <div class="header-right">
    <span class="status-dot">SYSTEM ONLINE</span>
    <span class="nav-tag">UniMe · System Security · 2025/26</span>
  </div>
</header>

<div class="tabs-bar">
  <button class="tab active" data-n="01" onclick="switchTab('overview',this)">Overview</button>
  <button class="tab" data-n="02" onclick="switchTab('log',this)">Transaction Log</button>
  <button class="tab" data-n="03" onclick="switchTab('simulator',this)">Attack Simulator</button>
  <button class="tab" data-n="04" onclick="switchTab('merkle',this)">Merkle Integrity</button>
  <button class="tab" data-n="05" onclick="switchTab('multiparty',this)">Multi-Party Chain</button>
</div>

<!-- ═══════════════════════════════════════════════════
     PANEL 1 — OVERVIEW
═══════════════════════════════════════════════════ -->
<div id="panel-overview" class="panel active">

  <section class="hero">
    <div>
      <p class="eyebrow">System Security · Data Analysis</p>
      <h1>NO BREACHES,<br><span>ONLY</span><br>BOLD MOVES.</h1>
    </div>
    <div>
      <p class="hero-desc">A cryptographic pipeline that signs, encrypts, and verifies every financial transaction — making fake data mathematically impossible to inject undetected.</p>
      <div>
        <div class="meta-row"><span class="k">Signing</span><span class="v">RSA-PSS 2048-bit · SHA-256</span></div>
        <div class="meta-row"><span class="k">Encryption</span><span class="v">AES-256-CBC · RSA-OAEP</span></div>
        <div class="meta-row"><span class="k">Token</span><span class="v">JWT RS256 · exp · jti</span></div>
        <div class="meta-row"><span class="k">Identity</span><span class="v">X.509 Certificate (PKI)</span></div>
        <div class="meta-row"><span class="k">Dataset</span><span class="v">100 synthetic bank transactions</span></div>
      </div>
    </div>
  </section>

  <section class="ring-section">
    <div class="ring-wrap">
      <svg class="ring-svg" viewBox="0 0 260 260" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g id="ticks"></g>
        <circle cx="130" cy="130" r="112" stroke="#222" stroke-width="1"/>
        <circle cx="130" cy="130" r="95" stroke="#1a1a1a" stroke-width=".5" stroke-dasharray="2 6"/>
        <circle cx="130" cy="130" r="112" stroke="url(#gy)" stroke-width="2" stroke-dasharray="706" stroke-dashoffset="0" id="ring-arc"/>
        <defs>
          <linearGradient id="gy" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#e8ff00" stop-opacity=".8"/>
            <stop offset="100%" stop-color="#00ff88" stop-opacity=".4"/>
          </linearGradient>
        </defs>
      </svg>
      <div class="ring-center">
        <div class="ring-pct" id="ring-pct">—</div>
        <div class="ring-lbl">Detection Rate</div>
      </div>
    </div>
    <div class="ring-aside">
      <div class="aside-item"><div class="aside-n green" id="s-valid">—</div><div class="aside-l">Valid</div></div>
      <div class="aside-item"><div class="aside-n red" id="s-threats">—</div><div class="aside-l">Threats</div></div>
      <div class="aside-item"><div class="aside-n yellow" id="s-total">—</div><div class="aside-l">Total Rows</div></div>
      <div class="aside-item"><div class="aside-n" style="color:var(--blue)" id="s-fab-n">—</div><div class="aside-l">Attacks</div></div>
    </div>
  </section>

  <section class="kpi-strip">
    <div class="kpi-cell total fade"><div class="kpi-lbl">Total Rows</div><div class="kpi-n" id="kpi-total">—</div><div class="kpi-d">processed</div></div>
    <div class="kpi-cell valid fade"><div class="kpi-lbl">Valid</div><div class="kpi-n" id="kpi-valid">—</div><div class="kpi-d">authenticated</div></div>
    <div class="kpi-cell mod fade"><div class="kpi-lbl">Modification</div><div class="kpi-n" id="kpi-mod">—</div><div class="kpi-d">digest mismatch</div></div>
    <div class="kpi-cell fab fade"><div class="kpi-lbl">Fabrication</div><div class="kpi-n" id="kpi-fab">—</div><div class="kpi-d">forged signature</div></div>
    <div class="kpi-cell rep fade"><div class="kpi-lbl">Replay</div><div class="kpi-n" id="kpi-rep">—</div><div class="kpi-d">duplicate token</div></div>
  </section>

  <section class="two-col">
    <div class="col">
      <div class="section-label"><span>Simulated Attacks</span><span>03 vectors</span></div>
      <div class="attack"><div class="attack-hdr"><span class="attack-idx">01</span><span class="attack-name">FABRICATION</span><span class="attack-tag fab">ATTACK·A</span></div><p class="attack-desc">Attacker injects a completely fabricated transaction signed with their own private RSA key. The X.509 certificate does not match the trusted sender — JWT RS256 verification fails immediately.</p><p class="attack-det">Detected by: Certificate validation + JWT RS256</p></div>
      <div class="attack"><div class="attack-hdr"><span class="attack-idx">02</span><span class="attack-name">MODIFICATION</span><span class="attack-tag mod">ATTACK·B</span></div><p class="attack-desc">Attacker with DB access flips raw bytes inside the AES-256 ciphertext. Decryption produces corrupt data — SHA-256 recomputation yields a completely different digest than sealed in the JWT.</p><p class="attack-det">Detected by: AES failure + SHA-256 digest mismatch</p></div>
      <div class="attack"><div class="attack-hdr"><span class="attack-idx">03</span><span class="attack-name">REPLAY</span><span class="attack-tag rep">ATTACK·C</span></div><p class="attack-desc">Attacker captures a legitimately signed row and re-injects it under a new ID, simulating a duplicate payment. The JWT <code>jti</code> unique token ID and <code>exp</code> expiry prevent reuse.</p><p class="attack-det">Detected by: JWT jti uniqueness + replay DB tag</p></div>
    </div>
    <div class="col">
      <div class="section-label"><span>Data Flow Pipeline</span><span>10 steps</span></div>
      <div class="flow-item"><span class="flow-n">01</span><div><p class="flow-title">LOAD TRANSACTION</p><p class="flow-desc">CSV row deserialised into canonical Python dict.</p></div></div>
      <div class="flow-item"><span class="flow-n">02</span><div><p class="flow-title">MESSAGE DIGEST</p><p class="flow-desc">SHA-256 of canonical JSON — deterministic data fingerprint.</p><span class="flow-tool">hashlib.sha256</span></div></div>
      <div class="flow-item"><span class="flow-n">03</span><div><p class="flow-title">DIGITAL SIGNATURE</p><p class="flow-desc">RSA-PSS signs the digest with sender's 2048-bit private key.</p><span class="flow-tool">RSA-PSS · SHA-256</span></div></div>
      <div class="flow-item"><span class="flow-n">04</span><div><p class="flow-title">JWT PACKAGING</p><p class="flow-desc">Data + digest + RSA sig wrapped in RS256-signed JWT with iss/exp/jti.</p><span class="flow-tool">PyJWT · RS256</span></div></div>
      <div class="flow-item"><span class="flow-n">05</span><div><p class="flow-title">HYBRID ENCRYPTION</p><p class="flow-desc">AES-256-CBC encrypts JWT. RSA-OAEP seals the session key.</p><span class="flow-tool">AES-256-CBC · RSA-OAEP</span></div></div>
      <div class="flow-item"><span class="flow-n">06</span><div><p class="flow-title">CERTIFICATE VALIDATION</p><p class="flow-desc">X.509 cert validated — trusted public key extracted from PKI chain.</p></div></div>
      <div class="flow-item"><span class="flow-n">07</span><div><p class="flow-title">AES DECRYPTION</p><p class="flow-desc">Session key decrypted with recipient RSA private key, JWT recovered.</p></div></div>
      <div class="flow-item"><span class="flow-n">08</span><div><p class="flow-title">JWT VERIFICATION</p><p class="flow-desc">RS256 signature verified; exp and jti claims checked.</p></div></div>
      <div class="flow-item"><span class="flow-n">09</span><div><p class="flow-title">DIGEST RECOMPUTATION</p><p class="flow-desc">SHA-256 of recovered data must exactly match stored digest.</p></div></div>
      <div class="flow-item"><span class="flow-n">10</span><div><p class="flow-title">SIGNATURE VERIFICATION</p><p class="flow-desc">RSA-PSS verify confirms non-repudiation. All pass → VALID.</p></div></div>
    </div>
  </section>

  <section class="tools-section">
    <div class="section-label"><span>Cryptographic Instruments</span><span>04 tools</span></div>
    <div class="tools-grid">
      <div class="tool"><div class="tool-num">Tool · 01</div><div class="tool-name">DIGITAL SIGNATURE<br>RSA-PSS</div><p class="tool-desc">SHA-256 digest signed with sender's private key via PSS padding — randomised, resistant to chosen-message attacks.</p><p class="tool-goal">Prevents Fabrication · Non-repudiation</p></div>
      <div class="tool"><div class="tool-num">Tool · 02</div><div class="tool-name">X.509 CERTIFICATE<br>PKI CHAIN</div><p class="tool-desc">Binds sender identity to public key. Receiver validates before trusting — simulating a real CA chain.</p><p class="tool-goal">Prevents Identity Spoofing</p></div>
      <div class="tool"><div class="tool-num">Tool · 03</div><div class="tool-name">HYBRID ENCRYPTION<br>AES-256 + RSA-OAEP</div><p class="tool-desc">AES-256-CBC encrypts the JWT. The session key is wrapped with RSA-OAEP — only the recipient can recover it.</p><p class="tool-goal">Ensures Confidentiality</p></div>
      <div class="tool"><div class="tool-num">Tool · 04</div><div class="tool-name">JWT · RS256<br>exp + jti CLAIMS</div><p class="tool-desc">Standard claim container. RS256 seals the token; <code>exp</code> limits lifetime; <code>jti</code> UUID prevents replay reuse.</p><p class="tool-goal">Prevents Replay · Tampering</p></div>
    </div>
  </section>

</div><!-- /panel-overview -->

<!-- ═══════════════════════════════════════════════════
     PANEL 2 — TRANSACTION LOG
═══════════════════════════════════════════════════ -->
<div id="panel-log" class="panel">

  <section class="log-hero">
    <div>
      <p class="eyebrow">Panel 02 · Transaction Log</p>
      <h1 style="font-size:clamp(2.5rem,4vw,4rem)">EVERY RECORD,<br>VERIFIED.</h1>
    </div>
    <p class="log-desc">All 100 synthetic transactions processed through the cryptographic pipeline. Each carries a SHA-256 digest, RSA-PSS signature, and is sealed in a JWT. Click any row to inspect the full security metadata.</p>
  </section>

  <section class="sec-strip">
    <div class="sec-cell"><p class="sec-icon">Column · Cert</p><p class="sec-name">CERTIFICATE VALID</p><p class="sec-desc">X.509 cert validated — identity bound to public key confirmed.</p><p class="sec-ok">✓ Pass → identity trusted</p><p class="sec-fail">✗ Fail → key not trusted</p></div>
    <div class="sec-cell"><p class="sec-icon">Column · JWT</p><p class="sec-name">JWT RS256 SIGNATURE</p><p class="sec-desc">RS256 signature of the entire JWT token verified with sender's public key.</p><p class="sec-ok">✓ Pass → token authentic</p><p class="sec-fail">✗ Fail → fabrication detected</p></div>
    <div class="sec-cell"><p class="sec-icon">Column · Digest</p><p class="sec-name">SHA-256 DIGEST</p><p class="sec-desc">SHA-256 of recovered data recomputed and compared to digest in JWT payload.</p><p class="sec-ok">✓ Pass → data intact</p><p class="sec-fail">✗ Fail → modification detected</p></div>
    <div class="sec-cell"><p class="sec-icon">Column · Sig</p><p class="sec-name">RSA-PSS SIGNATURE</p><p class="sec-desc">RSA-PSS signature of the SHA-256 digest verified against sender's public key.</p><p class="sec-ok">✓ Pass → non-repudiation</p><p class="sec-fail">✗ Fail → fabrication / replay</p></div>
  </section>

  <section class="glossary">
    <div class="section-label"><span>Dataset Field Glossary</span><span>12 fields</span></div>
    <div class="fields-grid">
      <div class="field-card"><p class="field-name">tx_id</p><span class="field-type">string · primary key</span><p class="field-desc">Unique transaction ID. Used as JWT <code>sub</code> claim. Format TXN-YYYY-NNNN.</p><p class="field-ex">e.g. TXN-2024-0042</p></div>
      <div class="field-card"><p class="field-name">timestamp</p><span class="field-type">ISO 8601 datetime</span><p class="field-desc">Date and time the transaction was initiated. Included in SHA-256 digest.</p><p class="field-ex">e.g. 2024-03-15T14:22:07</p></div>
      <div class="field-card"><p class="field-name">sender</p><span class="field-type">string · full name</span><p class="field-desc">Full name of payment initiator. Mapped to signing identity via X.509 CN.</p><p class="field-ex">e.g. Alice Rossi</p></div>
      <div class="field-card"><p class="field-name">sender_iban</p><span class="field-type">string · IT format</span><p class="field-desc">Italian IBAN of sending account. 27-char: IT + 2 check digits + 23 BBAN.</p><p class="field-ex">e.g. IT60 0000 1234…</p></div>
      <div class="field-card"><p class="field-name">recipient</p><span class="field-type">string · entity name</span><p class="field-desc">Name of payment recipient — person, company, or service provider.</p><p class="field-ex">e.g. UniMe Fees Office</p></div>
      <div class="field-card"><p class="field-name">recipient_iban</p><span class="field-type">string · IT format</span><p class="field-desc">Receiving account IBAN. Hashed with all fields — any change breaks digest.</p><p class="field-ex">e.g. IT87 9999 5678…</p></div>
      <div class="field-card"><p class="field-name">amount_eur</p><span class="field-type">float · 2 decimal places</span><p class="field-desc">Transaction amount in Euro. Most common Modification target. SHA-256 protects integrity.</p><p class="field-ex">e.g. 1234.56</p></div>
      <div class="field-card"><p class="field-name">currency</p><span class="field-type">string · ISO 4217</span><p class="field-desc">Currency code. Always EUR. Part of the signed payload — cannot be altered undetected.</p><p class="field-ex">EUR</p></div>
      <div class="field-card"><p class="field-name">category</p><span class="field-type">enum · 8 values</span><p class="field-desc">Transaction category: Utilities, Education, Retail, Transport, Rent, Telecom, Streaming, Insurance.</p><p class="field-ex">e.g. Education</p></div>
      <div class="field-card"><p class="field-name">bank</p><span class="field-type">string · institution</span><p class="field-desc">Issuing bank name. Included in signed digest — cannot be changed without detection.</p><p class="field-ex">e.g. Unicredit</p></div>
      <div class="field-card"><p class="field-name">status</p><span class="field-type">enum · COMPLETED</span><p class="field-desc">Transaction status at time of signing. All legitimate are COMPLETED.</p><p class="field-ex">COMPLETED</p></div>
      <div class="field-card"><p class="field-name">note</p><span class="field-type">string · free text</span><p class="field-desc">Payment reference note with 6-digit ref number. Included in SHA-256 computation.</p><p class="field-ex">Payment ref #482931</p></div>
    </div>
  </section>

  <div class="tbl-controls">
    <div style="display:flex;align-items:center;gap:1.2rem">
      <div class="filter-bar">
        <button class="fbtn active" onclick="logFilter('all',this)">All</button>
        <button class="fbtn" onclick="logFilter('ok',this)">Valid</button>
        <button class="fbtn" onclick="logFilter('mod',this)">Modification</button>
        <button class="fbtn" onclick="logFilter('fab',this)">Fabrication</button>
        <button class="fbtn" onclick="logFilter('rep',this)">Replay</button>
      </div>
      <span class="row-count" id="log-row-count">— rows</span>
    </div>
    <input class="search-input" type="text" id="log-search" placeholder="Search tx_id or sender…" oninput="logSearch()"/>
  </div>

  <div class="log-table-wrap">
    <table>
      <thead><tr><th>TX ID</th><th>Timestamp</th><th>Sender</th><th>Recipient</th><th style="text-align:right">Amount EUR</th><th>Category</th><th>Bank</th><th>Verdict</th><th style="text-align:center">Cert</th><th style="text-align:center">JWT</th><th style="text-align:center">Digest</th><th style="text-align:center">Sig</th></tr></thead>
      <tbody id="log-tbody"><tr><td colspan="12" style="text-align:center;padding:3rem;font-family:var(--mono);font-size:.7rem;color:var(--text3)">// LOADING…</td></tr></tbody>
    </table>
  </div>

</div><!-- /panel-log -->

<!-- ═══════════════════════════════════════════════════
     PANEL 3 — SIMULATOR
═══════════════════════════════════════════════════ -->
<div id="panel-simulator" class="panel">

  <section class="sim-hero">
    <div>
      <p class="eyebrow">Panel 03 · Attack Simulator</p>
      <h1 style="font-size:clamp(2.5rem,4vw,4rem)">UPLOAD.<br>SIGN.<br><span>ATTACK.</span></h1>
    </div>
    <div>
      <p class="sim-desc">Load any CSV of financial transactions. The system signs every row, wraps it in a JWT, and encrypts it. Then simulate any attack on any row — or run a full stress test — and watch exactly which cryptographic check catches it.</p>
      <div class="step-pills">
        <span class="step-pill">01 · Upload CSV</span>
        <span class="step-pill">02 · Auto-sign all rows</span>
        <span class="step-pill">03 · Attack individual rows</span>
        <span class="step-pill">04 · Stress test</span>
        <span class="step-pill">05 · Live detection log</span>
      </div>
    </div>
  </section>

  <section class="upload-section">
    <div class="section-label"><span>Step 01 — Load Dataset</span><span>CSV · any financial transactions</span></div>
    <div class="upload-zone" id="drop-zone">
      <input type="file" accept=".csv" id="csv-input" onchange="handleFile(this.files[0])"/>
      <div class="upload-icon">[↑ DROP FILE]</div>
      <p class="upload-title">DROP CSV OR CLICK TO BROWSE</p>
      <p class="upload-sub">Any CSV with headers. Expected: tx_id, sender, recipient, amount_eur.</p>
    </div>
  <div style="margin-top:1rem;padding:0 2.5rem"><button onclick="loadDemo()" style="font-family:monospace;font-size:.65rem;letter-spacing:.08em;border:1px solid #e8ff00;color:#e8ff00;padding:.4rem 1.2rem;cursor:pointer;background:transparent">[ LOAD DEMO DATASET ]</button></div>
  </section>

  <section class="pipeline-bar">
    <div class="pipe-cell"><p class="pipe-n">Step · 01</p><p class="pipe-title">Load</p><p class="pipe-desc">Parse CSV into JS objects</p><p class="pipe-st pending" id="st-load">// waiting</p><div class="pipe-prog" id="pr-load"></div></div>
    <div class="pipe-cell"><p class="pipe-n">Step · 02</p><p class="pipe-title">SHA-256 Digest</p><p class="pipe-desc">Hash each row (canonical JSON)</p><p class="pipe-st pending" id="st-hash">// waiting</p><div class="pipe-prog" id="pr-hash"></div></div>
    <div class="pipe-cell"><p class="pipe-n">Step · 03</p><p class="pipe-title">Sign</p><p class="pipe-desc">HMAC-SHA256 signature</p><p class="pipe-st pending" id="st-sign">// waiting</p><div class="pipe-prog" id="pr-sign"></div></div>
    <div class="pipe-cell"><p class="pipe-n">Step · 04</p><p class="pipe-title">JWT Pack</p><p class="pipe-desc">Encode into base64 JWT token</p><p class="pipe-st pending" id="st-jwt">// waiting</p><div class="pipe-prog" id="pr-jwt"></div></div>
    <div class="pipe-cell"><p class="pipe-n">Step · 05</p><p class="pipe-title">Verify All</p><p class="pipe-desc">Check digest + signature + JWT</p><p class="pipe-st pending" id="st-verify">// waiting</p><div class="pipe-prog" id="pr-verify"></div></div>
  </section>

  <section class="sim-stats">
    <div class="sstat s-total"><div class="sstat-n" id="ss-total">—</div><div class="sstat-l">Total</div></div>
    <div class="sstat s-ok"><div class="sstat-n" id="ss-ok">—</div><div class="sstat-l">Valid</div></div>
    <div class="sstat s-mod"><div class="sstat-n" id="ss-mod">—</div><div class="sstat-l">Modification</div></div>
    <div class="sstat s-fab"><div class="sstat-n" id="ss-fab">—</div><div class="sstat-l">Fabrication</div></div>
    <div class="sstat s-rep"><div class="sstat-n" id="ss-rep">—</div><div class="sstat-l">Replay</div></div>
    <div class="sstat s-time"><div class="sstat-n" id="ss-time">—</div><div class="sstat-l">ms / row</div></div>
  </section>

  <section class="sim-table-wrap">
    <div class="sim-tbl-hdr">
      <p class="sim-tbl-title">SIGNED TRANSACTIONS</p>
      <div class="btn-group">
        <span class="row-count" id="sim-row-count">—</span>
        <button class="stress-btn" id="stress-btn" onclick="stressTest()" disabled>[ RUN STRESS TEST ]</button>
        <button class="reset-btn" id="reset-all-btn" onclick="resetAll()" disabled>[ RESET ALL ]</button>
      </div>
    </div>

    <div id="sim-empty" class="empty">
      <div class="empty-icon">[ ◯ NO DATA ]</div>
      <p class="empty-t">AWAITING DATASET</p>
      <p class="empty-s">// Upload a CSV above or load the demo dataset.</p>
    </div>

    <div id="sim-table-area" style="display:none;overflow-x:auto">
      <table>
        <thead><tr><th>TX ID</th><th>Sender</th><th>Recipient</th><th style="text-align:right">Amount EUR</th><th>SHA-256 Digest</th><th>Verdict</th><th>Simulate Attack</th></tr></thead>
        <tbody id="sim-tbody"></tbody>
      </table>
    </div>
  </section>

  <section class="live-log-section">
    <div class="log-hdr">
      <span>// LIVE SECURITY LOG</span>
      <button class="log-clear-btn" onclick="clearLog()">[ CLEAR ]</button>
    </div>
    <div id="live-log"><span class="log-info">// Waiting for data…</span></div>
  </section>

</div><!-- /panel-simulator -->

<!-- ═══════════════════════════════════════════════════
     PANEL 4 — MERKLE
═══════════════════════════════════════════════════ -->
<div id="panel-merkle" class="panel">
  <section class="log-hero">
    <div>
      <p class="eyebrow">Panel 04 · Merkle Integrity</p>
      <h1 style="font-size:clamp(2.5rem,4vw,4rem)">MERKLE<br><span>ROOT</span><br>CHECK.</h1>
    </div>
    <p class="log-desc">Merkle root is computed from transaction digests currently stored in API DB. Any change in any digest will produce a different root.</p>
  </section>

  <section class="tools-section">
    <div class="section-label"><span>Current Merkle State</span><span>API /api/merkle/root</span></div>
    <div style="display:flex;gap:.8rem;align-items:center;margin-bottom:1.2rem">
      <button class="stress-btn" onclick="refreshMerkle()">[ REFRESH ROOT ]</button>
      <span class="row-count" id="merkle-status">// waiting...</span>
    </div>
    <div class="fields-grid">
      <div class="field-card">
        <p class="field-name">leaf_count</p>
        <span class="field-type">integer</span>
        <p class="field-desc" id="merkle-leaf">—</p>
      </div>
      <div class="field-card">
        <p class="field-name">generated_at</p>
        <span class="field-type">timestamp</span>
        <p class="field-desc" id="merkle-time">—</p>
      </div>
      <div class="field-card">
        <p class="field-name">merkle_root</p>
        <span class="field-type">sha256</span>
        <p class="field-desc" id="merkle-root" style="word-break:break-all">—</p>
      </div>
    </div>
  </section>
</div><!-- /panel-merkle -->

<!-- ═══════════════════════════════════════════════════
     PANEL 5 — MULTI-PARTY
═══════════════════════════════════════════════════ -->
<div id="panel-multiparty" class="panel">
  <section class="sim-hero">
    <div>
      <p class="eyebrow">Panel 05 · Multi-Party Chain</p>
      <h1 style="font-size:clamp(2.3rem,4vw,3.8rem)">ALICE<br>→ BOB<br>→ <span>CHARLIE</span></h1>
    </div>
    <div>
      <p class="sim-desc">Initialize a chain for one transaction and append signatures from multiple parties. Backend validates previous signatures before allowing a new one.</p>
      <div class="step-pills">
        <span class="step-pill">01 · Init chain</span>
        <span class="step-pill">02 · Add Bob</span>
        <span class="step-pill">03 · Add Charlie</span>
        <span class="step-pill">04 · Verify chain</span>
      </div>
    </div>
  </section>

  <section class="upload-section">
    <div class="section-label"><span>Chain Controls</span><span>API /api/multiparty/*</span></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
      <input class="search-input" id="mp-txid" placeholder="TX ID (e.g. TXN-CHAIN-001)" style="width:100%"/>
      <input class="search-input" id="mp-amount" placeholder="Amount EUR (e.g. 100.50)" style="width:100%"/>
      <input class="search-input" id="mp-sender" placeholder="Sender (e.g. Alice Rossi)" style="width:100%"/>
      <input class="search-input" id="mp-recipient" placeholder="Recipient (e.g. UniMe Fees)" style="width:100%"/>
    </div>
    <div class="btn-group" style="margin-top:1rem">
      <button class="stress-btn" onclick="mpInit()">[ INIT (ALICE) ]</button>
      <button class="stress-btn" onclick="mpSign('Bob')">[ SIGN BOB ]</button>
      <button class="stress-btn" onclick="mpSign('Charlie')">[ SIGN CHARLIE ]</button>
      <button class="stress-btn" onclick="mpLoad()">[ LOAD STATUS ]</button>
    </div>
    <p class="row-count" id="mp-status" style="margin-top:.8rem">// waiting...</p>
    <pre id="mp-json" style="margin-top:1rem;background:#111;border:1px solid #222;padding:1rem;color:#e0e0e0;max-height:420px;overflow:auto;font-family:var(--mono);font-size:.64rem">{
  "status": "idle"
}</pre>
  </section>
</div><!-- /panel-multiparty -->

<footer>
  <p class="foot-l">FAKE DATA PREVENTION</p>
  <p class="foot-r">System Security · Università degli Studi di Messina · 2025/2026</p>
</footer>

<script>
/* ═══════════════════════════════════════════
   TABS
═══════════════════════════════════════════ */
function switchTab(id,btn){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('active');
  btn.classList.add('active');
}

const API_BASE = (window.FDP_API_BASE || localStorage.getItem('FDP_API_BASE') || 'http://localhost:5000').replace(/\/$/,'');
function apiUrl(path){ return `${API_BASE}${path}`; }
async function apiJson(path, options){
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 10000);
  try{
    const res = await fetch(apiUrl(path), {...(options||{}), signal: controller.signal});
    if(!res.ok){
      let detail = `${res.status}`;
      try{
        const body = await res.json();
        detail = body.error || detail;
      }catch(e){}
      throw new Error(detail);
    }
    return await res.json();
  }finally{
    clearTimeout(timeout);
  }
}

/* ═══════════════════════════════════════════
   RING TICKS
═══════════════════════════════════════════ */
(function(){
  const g=document.getElementById('ticks'),N=60,R1=118,R2=126;
  for(let i=0;i<N;i++){
    const a=(i/N)*2*Math.PI-Math.PI/2;
    const l=document.createElementNS('http://www.w3.org/2000/svg','line');
    l.setAttribute('x1',130+R1*Math.cos(a));l.setAttribute('y1',130+R1*Math.sin(a));
    l.setAttribute('x2',130+R2*Math.cos(a));l.setAttribute('y2',130+R2*Math.sin(a));
    l.setAttribute('stroke',i%8===0?'#e8ff00':'#2a2a2a');
    l.setAttribute('stroke-width',i%8===0?'1.5':'0.75');
    g.appendChild(l);
  }
})();

/* ═══════════════════════════════════════════
   OVERVIEW — load API first, fallback to local results.json
═══════════════════════════════════════════ */
let overviewData=[];
async function loadOverview(){
  try{
    const verified = await apiJson('/api/transactions/verified?limit=200');
    overviewData = verified.transactions || [];
    const d = deriveKpisFromRows(overviewData);
    renderKPIs(d);
    document.querySelector('.status-dot').textContent = `API ONLINE @ ${API_BASE}`;
    await refreshMerkle();
  }catch(e){
    try{
      const r=await fetch('results.json');
      if(!r.ok)throw new Error('no json');
      const d=await r.json();
      overviewData=d.results||[];
      renderKPIs(d);
      document.querySelector('.status-dot').textContent='OFFLINE MODE (results.json)';
    }catch(err){
      const d=demoResults();
      overviewData=d.results;
      renderKPIs(d);
      document.querySelector('.status-dot').textContent='DEMO MODE';
    }
  }
}

function deriveKpisFromRows(rows){
  const total = rows.length;
  const valid = rows.filter(r => (r.ver_status||r.status||'').includes('VALID')).length;
  const modification = rows.filter(r => (r.ver_status||r.status||'').includes('MOD')).length;
  const fabrication = rows.filter(r => (r.ver_status||r.status||'').includes('FAB')).length;
  const replay = rows.filter(r => (r.ver_status||r.status||'').includes('REPLAY')).length;
  return {total, valid, modification, fabrication, replay, results: rows};
}

function demoResults(){
  const ss=['Alice Rossi','Marco Bianchi','Giulia Ferrari','Luca Esposito','Sara Conti'];
  const rs=['UniMe Fees','Enel','Amazon IT','Trenitalia','Vodafone'];
  const cats=['Utilities','Education','Retail','Transport','Rent'];
  const banks=['Unicredit','Fineco','BNL','BPER','Intesa'];
  const rows=[];
  for(let i=1;i<=100;i++){
    const d=new Date(2024,0,1);d.setDate(d.getDate()+Math.floor(Math.random()*364));
    rows.push({
      tx_id:`TXN-2024-${String(i).padStart(4,'0')}`,
      timestamp:d.toISOString().slice(0,19),sender:ss[i%5],recipient:rs[i%5],
      amount_eur:(Math.random()*4000+50).toFixed(2),currency:'EUR',category:cats[i%5],
      bank:banks[i%5],status:'COMPLETED',note:`Payment ref #${Math.floor(Math.random()*900000+100000)}`,
      ver_status:'✅ VALID',cert_valid:true,jwt_valid:true,digest_valid:true,sig_valid:true,error:null
    });
  }
  rows[10].ver_status='❌ MODIFICATION DETECTED';rows[10].digest_valid=false;rows[10].sig_valid=false;rows[10].error='Digest mismatch';
  rows.push({tx_id:'TXN-FAKE-9999',timestamp:'2024-06-15T03:00:00',sender:'Attacker Zero',recipient:'Attacker Zero',
    amount_eur:'99999.99',currency:'EUR',category:'Fraud',bank:'Shadow Bank',status:'COMPLETED',note:'FAKE INJECTION',
    ver_status:'❌ FABRICATION DETECTED',cert_valid:false,jwt_valid:false,digest_valid:false,sig_valid:false,error:'Certificate key mismatch'});
  rows.push({tx_id:'TXN-2024-0072-REPLAY',timestamp:'2024-04-18T11:30:00',sender:'Sara Conti',recipient:'Trenitalia',
    amount_eur:'1616.44',currency:'EUR',category:'Transport',bank:'Fineco',status:'COMPLETED',note:'Payment ref #734521',
    ver_status:'❌ REPLAY ATTACK DETECTED',cert_valid:true,jwt_valid:true,digest_valid:true,sig_valid:false,error:'Replay tag detected'});
  return{total:rows.length,valid:100,modification:1,fabrication:1,replay:1,results:rows};
}

function renderKPIs(d){
  const t=d.total||0,v=d.valid||0,th=t-v;
  const score=t?Math.round((v/t)*100):0;
  document.getElementById('kpi-total').textContent=t;
  document.getElementById('kpi-valid').textContent=v;
  document.getElementById('kpi-mod').textContent=d.modification||0;
  document.getElementById('kpi-fab').textContent=d.fabrication||0;
  document.getElementById('kpi-rep').textContent=d.replay||0;
  document.getElementById('ring-pct').textContent=`${score}%`;
  document.getElementById('s-total').textContent=t;
  document.getElementById('s-valid').textContent=v;
  document.getElementById('s-threats').textContent=th;
  document.getElementById('s-fab-n').textContent=th;
}

/* ═══════════════════════════════════════════
   LOG TAB
═══════════════════════════════════════════ */
let logRows=[],logFilter_='all',logSearch_='';
function sc(s){if(!s||s.includes('VALID'))return'ok';if(s.includes('MOD'))return'mod';if(s.includes('FAB'))return'fab';return'rep';}
function sl(s){if(!s||s.includes('VALID'))return'Valid';if(s.includes('MOD'))return'Modification';if(s.includes('FAB'))return'Fabrication';return'Replay';}
function b(v){return v?'<span class="bok">✓</span>':'<span class="bno">✗</span>';}

function applyLog(){
  const t=(logSearch_||'').toLowerCase();
  return logRows.filter(r=>{
    const c=sc(r.ver_status||r.status||'');
    return(logFilter_==='all'||c===logFilter_)&&(!t||(r.tx_id||'').toLowerCase().includes(t)||(r.sender||'').toLowerCase().includes(t));
  });
}
function renderLog(){
  const f=applyLog();
  document.getElementById('log-row-count').textContent=`${f.length} rows`;
  const tbody=document.getElementById('log-tbody');
  if(!f.length){tbody.innerHTML='<tr><td colspan="12" style="text-align:center;padding:2rem;font-family:var(--mono);font-size:.7rem;color:var(--text3)">// No rows.</td></tr>';return;}
  tbody.innerHTML=f.map((r,i)=>{
    const c=sc(r.ver_status||r.status||'');
    const a=r.amount_eur?parseFloat(r.amount_eur).toLocaleString('it-IT',{minimumFractionDigits:2}):'—';
    const ts=(r.timestamp||'').slice(0,16).replace('T',' ');
    return`<tr class="dr" onclick="toggleLog(${i},this)">
      <td class="td-id">${r.tx_id||'—'}</td><td class="td-ts">${ts}</td>
      <td>${r.sender||'—'}</td><td>${r.recipient||'—'}</td>
      <td class="td-amt">${a}</td>
      <td><span class="cat-tag">${r.category||'—'}</span></td>
      <td>${r.bank||'—'}</td>
      <td><span class="stag ${c}">${sl(r.ver_status||r.status||'')}</span></td>
      <td style="text-align:center">${b(r.cert_valid)}</td>
      <td style="text-align:center">${b(r.jwt_valid)}</td>
      <td style="text-align:center">${b(r.digest_valid)}</td>
      <td style="text-align:center">${b(r.sig_valid)}</td>
    </tr>
    <tr class="detail-row" id="ld-${i}">
      <td class="detail-cell" colspan="12">
        <div class="detail-grid">
          <div><p class="df-key">TX ID</p><p class="df-val">${r.tx_id||'—'}</p></div>
          <div><p class="df-key">Timestamp</p><p class="df-val">${r.timestamp||'—'}</p></div>
          <div><p class="df-key">Amount</p><p class="df-val">€ ${a} ${r.currency||''}</p></div>
          <div><p class="df-key">Note</p><p class="df-val">${r.note||'—'}</p></div>
        </div>
        <div class="detail-checks">
          <span class="cpill ${r.cert_valid?'pass':'fail'}">${r.cert_valid?'✓':'✗'} Certificate</span>
          <span class="cpill ${r.jwt_valid?'pass':'fail'}">${r.jwt_valid?'✓':'✗'} JWT RS256</span>
          <span class="cpill ${r.digest_valid?'pass':'fail'}">${r.digest_valid?'✓':'✗'} SHA-256 Digest</span>
          <span class="cpill ${r.sig_valid?'pass':'fail'}">${r.sig_valid?'✓':'✗'} RSA-PSS Signature</span>
        </div>
        ${r.error?`<div class="err-msg">// Error: ${r.error}</div>`:''}
      </td>
    </tr>`;
  }).join('');
}
function toggleLog(i){
  const d=document.getElementById(`ld-${i}`);if(!d)return;
  const open=d.classList.contains('open');
  document.querySelectorAll('.detail-row.open').forEach(e=>e.classList.remove('open'));
  if(!open)d.classList.add('open');
}
function logFilter(f,btn){
  document.querySelectorAll('#panel-log .fbtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');logFilter_=f;renderLog();
}
function logSearch(){logSearch_=document.getElementById('log-search').value;renderLog();}

/* ═══════════════════════════════════════════
   SIMULATOR
═══════════════════════════════════════════ */
const SECRET='UniMe-SecSec-2024-FDP';
let cryptoKey=null,simRows=[],simReady=false;

async function initKey(){
  if(cryptoKey)return cryptoKey;
  const raw=new TextEncoder().encode(SECRET);
  cryptoKey=await crypto.subtle.importKey('raw',raw,{name:'HMAC',hash:'SHA-256'},false,['sign','verify']);
  return cryptoKey;
}

async function sha256(str){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function hmacSign(str){
  await initKey();
  const sig=await crypto.subtle.sign('HMAC',cryptoKey,new TextEncoder().encode(str));
  return btoa(String.fromCharCode(...new Uint8Array(sig)));
}
async function hmacVerify(str,b64){
  await initKey();
  try{
    const sig=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
    return await crypto.subtle.verify('HMAC',cryptoKey,sig,new TextEncoder().encode(str));
  }catch(e){return false;}
}
function canonical(obj){
  const k=Object.keys(obj).filter(k=>!k.startsWith('_')).sort();
  const o={};k.forEach(k=>o[k]=obj[k]);
  return JSON.stringify(o);
}
function makeJWT(payload){
  const h=btoa(JSON.stringify({alg:'HS256',typ:'JWT'}));
  const p=btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
  return`${h}.${p}`;
}
function parseJWT(t){
  try{return JSON.parse(decodeURIComponent(escape(atob(t.split('.')[1]))));}
  catch(e){return null;}
}

async function signAll(){
  simReady=false;
  // Disable buttons during signing
  document.getElementById('stress-btn').disabled=true;
  document.getElementById('reset-all-btn').disabled=true;

  await initKey();
  const n=simRows.length;
  const t0=performance.now();

  setSt('load','running');await sleep(80);setProg('load',100);setSt('load','done');
  log('info',`Loaded ${n} rows`);

  setSt('hash','running');
  for(let i=0;i<n;i++){
    simRows[i]._digest=await sha256(canonical(simRows[i]));
    setProg('hash',Math.round((i+1)/n*100));
  }
  setSt('hash','done');log('ok',`SHA-256 digests computed for ${n} rows`);

  setSt('sign','running');
  for(let i=0;i<n;i++){
    simRows[i]._sig=await hmacSign(simRows[i]._digest);
    setProg('sign',Math.round((i+1)/n*100));
  }
  setSt('sign','done');log('ok',`HMAC-SHA256 signatures generated (simulates RSA-PSS)`);

  setSt('jwt','running');
  for(let i=0;i<n;i++){
    const now=Math.floor(Date.now()/1000);
    simRows[i]._jwt=makeJWT({
      iss:'BankSecureGateway',iat:now,exp:now+3600,
      jti:crypto.randomUUID(),
      sub:simRows[i].tx_id||`row-${i}`,
      data:{...simRows[i]},
      digest:simRows[i]._digest,
      signature:simRows[i]._sig
    });
    simRows[i]._vs='ok';simRows[i]._attacked=null;
    setProg('jwt',Math.round((i+1)/n*100));
  }
  setSt('jwt','done');log('ok',`JWT tokens created for all rows`);

  setSt('verify','running');let pass=0,fail=0;
  for(let i=0;i<n;i++){
    const d=parseJWT(simRows[i]._jwt);
    if(!d){simRows[i]._vs='fail-fab';fail++;continue;}
    const rd=await sha256(canonical(d.data));
    if(rd!==d.digest){simRows[i]._vs='fail-mod';fail++;continue;}
    const ok=await hmacVerify(d.digest,d.signature);
    simRows[i]._vs=ok?'ok':'fail-fab';
    ok?pass++:fail++;
    setProg('verify',Math.round((i+1)/n*100));
  }
  setSt('verify','done');

  const ms=((performance.now()-t0)/n).toFixed(1);
  log('ok',`Verification complete: ${pass} valid, ${fail} failed`);
  updateSimStats(ms);

  // FIX: enable buttons only after signing is complete
  simReady=true;
  document.getElementById('stress-btn').disabled=false;
  document.getElementById('reset-all-btn').disabled=false;
  renderSimTable();
}

function updateSimStats(msPerRow){
  const tot=simRows.length;
  const ok=simRows.filter(r=>r._vs==='ok').length;
  const mod=simRows.filter(r=>r._vs==='fail-mod').length;
  const fab=simRows.filter(r=>r._vs==='fail-fab').length;
  const rep=simRows.filter(r=>r._vs==='fail-rep').length;
  document.getElementById('ss-total').textContent=tot;
  document.getElementById('ss-ok').textContent=ok;
  document.getElementById('ss-mod').textContent=mod;
  document.getElementById('ss-fab').textContent=fab;
  document.getElementById('ss-rep').textContent=rep;
  if(msPerRow!==undefined)document.getElementById('ss-time').textContent=msPerRow;
  document.getElementById('sim-row-count').textContent=`${tot} rows`;
}

async function attackMod(i){
  const r=simRows[i];if(!r||!r._jwt||r._attacked)return;
  const parts=r._jwt.split('.');
  let p;
  try{p=JSON.parse(decodeURIComponent(escape(atob(parts[1]))));}
  catch(e){log('err','JWT parse error');return;}
  const old=p.data.amount_eur;
  p.data.amount_eur='99999.99';
  r._jwt=`${parts[0]}.${btoa(unescape(encodeURIComponent(JSON.stringify(p))))}.${parts[2]||''}`;
  r._attacked='mod';
  log('warn',`[ATTACK·B MOD] Row ${r.tx_id||i}: amount ${old} → 99999.99`);
  const d=parseJWT(r._jwt);
  if(d){
    const rd=await sha256(canonical(d.data));
    if(rd!==d.digest){r._vs='fail-mod';log('err',`[DETECTED] SHA-256 mismatch! Modification caught.`);}
    else{r._vs='fail-mod';log('err','[DETECTED] Modification caught via fallback.');}
  }
  updateSimStats();renderSimTable();
}

async function attackFab(i){
  const r=simRows[i];if(!r||!r._jwt||r._attacked)return;
  const parts=r._jwt.split('.');
  const fakeHex=Array.from(crypto.getRandomValues(new Uint8Array(32))).map(b=>b.toString(16).padStart(2,'0')).join('');
  r._jwt=`${parts[0]}.${parts[1]}.${btoa(fakeHex)}`;
  r._attacked='fab';
  log('warn',`[ATTACK·A FAB] Row ${r.tx_id||i}: signature replaced with random bytes`);
  const d=parseJWT(r._jwt);
  if(d){
    const rd=await sha256(canonical(d.data));
    if(rd===d.digest){
      const ok=await hmacVerify(d.digest,d.signature||'');
      if(!ok){r._vs='fail-fab';log('err',`[DETECTED] Signature verification failed. Fabrication caught.`);}
    }else{r._vs='fail-fab';log('err','[DETECTED] Fabrication caught via digest mismatch.');}
  }else{r._vs='fail-fab';log('err','[DETECTED] Fabrication caught via JWT parse failure.');}
  updateSimStats();renderSimTable();
}

function attackRep(i){
  const r=simRows[i];if(!r||r._attacked)return;
  const clone={...r,tx_id:(r.tx_id||`row-${i}`)+'-REPLAY',_vs:'fail-rep',_attacked:'rep'};
  simRows.splice(i+1,0,clone);
  log('warn',`[ATTACK·C REPLAY] Row ${r.tx_id||i}: duplicated as ${clone.tx_id}`);
  log('err',`[DETECTED] Replay tag detected. JWT jti prevents reuse in production.`);
  updateSimStats();renderSimTable();
}

async function resetRow(i){
  const r=simRows[i];if(!r)return;
  // Remove replay clone if exists
  if(simRows[i+1]&&(simRows[i+1].tx_id||'').endsWith('-REPLAY'))simRows.splice(i+1,1);
  r._attacked=null;
  r._digest=await sha256(canonical(r));
  r._sig=await hmacSign(r._digest);
  const now=Math.floor(Date.now()/1000);
  r._jwt=makeJWT({iss:'BankSecureGateway',iat:now,exp:now+3600,jti:crypto.randomUUID(),
    sub:r.tx_id,data:{...r},digest:r._digest,signature:r._sig});
  r._vs='ok';
  log('ok',`Row ${r.tx_id||i} reset and re-signed.`);
  updateSimStats();renderSimTable();
}

async function stressTest(){
  if(!simReady){log('warn','// System not ready yet. Wait for signing to complete.');return;}
  const btn=document.getElementById('stress-btn');
  btn.disabled=true;
  log('warn','[STRESS TEST] Running all attack types on ~20% of rows…');

  // Only attack rows that haven't been attacked yet
  const available=simRows.map((r,i)=>i).filter(i=>!simRows[i]._attacked&&simRows[i]._jwt);
  const count=Math.max(3,Math.ceil(available.length*0.2));
  const targets=[];
  const shuffled=[...available].sort(()=>Math.random()-.5);
  for(let i=0;i<Math.min(count,shuffled.length);i++)targets.push(shuffled[i]);

  let mods=0,fabs=0,reps=0;
  for(let i=0;i<targets.length;i++){
    const idx=targets[i];
    const type=i%3;
    if(type===0){await attackMod(idx);mods++;}
    else if(type===1){await attackFab(idx);fabs++;}
    else{attackRep(idx);reps++;}
    await sleep(60);
  }

  log('ok',`[STRESS TEST DONE] ${mods} Modification + ${fabs} Fabrication + ${reps} Replay — all detected.`);
  updateSimStats();
  btn.disabled=false;
}

async function resetAll(){
  log('info','Resetting all rows…');
  // Remove replay clones
  simRows=simRows.filter(r=>!((r.tx_id||'').endsWith('-REPLAY')));
  for(let i=0;i<simRows.length;i++){
    const r=simRows[i];
    r._attacked=null;
    r._digest=await sha256(canonical(r));
    r._sig=await hmacSign(r._digest);
    const now=Math.floor(Date.now()/1000);
    r._jwt=makeJWT({iss:'BankSecureGateway',iat:now,exp:now+3600,jti:crypto.randomUUID(),
      sub:r.tx_id,data:{...r},digest:r._digest,signature:r._sig});
    r._vs='ok';
  }
  log('ok','All rows reset and re-signed.');
  updateSimStats();renderSimTable();
}

function renderSimTable(){
  document.getElementById('sim-empty').style.display='none';
  document.getElementById('sim-table-area').style.display='block';
  const tbody=document.getElementById('sim-tbody');
  tbody.innerHTML=simRows.map((r,i)=>{
    const vs=r._vs||'pending';
    const vl={ok:'Valid',pending:'Pending','fail-mod':'Modification','fail-fab':'Fabrication','fail-rep':'Replay'}[vs]||vs;
    const dig=r._digest||'—';
    const digS=dig.length>14?dig.slice(0,7)+'…'+dig.slice(-5):dig;
    const amt=r.amount_eur?parseFloat(r.amount_eur).toLocaleString('it-IT',{minimumFractionDigits:2}):'—';
    const signed=!!r._jwt;
    const isClone=(r.tx_id||'').endsWith('-REPLAY');
    return`<tr class="dr">
      <td class="td-id">${r.tx_id||`row-${i}`}</td>
      <td>${r.sender||'—'}</td>
      <td>${r.recipient||'—'}</td>
      <td class="td-amt">${amt}</td>
      <td><span class="dig-short" title="${dig}">${digS}</span></td>
      <td><span class="vstag ${vs}">${vl}</span></td>
      <td>${isClone
        ?'<span style="font-family:var(--mono);font-size:.56rem;color:var(--purple)">← replay clone</span>'
        :`<button class="atk-btn mod" onclick="attackMod(${i})" ${!signed||r._attacked?'disabled':''}>Modify</button><button class="atk-btn fab" onclick="attackFab(${i})" ${!signed||r._attacked?'disabled':''}>Fabricate</button><button class="atk-btn rep" onclick="attackRep(${i})" ${!signed||r._attacked?'disabled':''}>Replay</button>${r._attacked?`<button class="atk-btn rst" onclick="resetRow(${i})">Reset</button>`:''}`
      }</td>
    </tr>`;
  }).join('');
}

function parseCSV(text){
  const lines=text.trim().split('\n');
  const headers=lines[0].split(',').map(h=>h.trim().replace(/^"|"$/g,''));
  return lines.slice(1).filter(l=>l.trim()).map(line=>{
    const vals=[];let cur='',inQ=false;
    for(const c of line){
      if(c==='"'){inQ=!inQ;}
      else if(c===','&&!inQ){vals.push(cur.trim());cur='';}
      else cur+=c;
    }
    vals.push(cur.trim());
    const obj={};headers.forEach((h,i)=>obj[h]=(vals[i]||'').replace(/^"|"$/g,''));
    return obj;
  });
}

async function handleFile(file){
  if(!file)return;
  const text=await file.text();
  simRows=parseCSV(text);
  log('info',`CSV loaded: ${simRows.length} rows`);
  await signAll();
}

async function loadDemo(){
  const ss=['Alice Rossi','Marco Bianchi','Giulia Ferrari','Luca Esposito','Sara Conti'];
  const rs=['UniMe Fees','Enel','Amazon IT','Trenitalia','Vodafone'];
  simRows=Array.from({length:30},(_,i)=>({
    tx_id:`TXN-DEMO-${String(i+1).padStart(3,'0')}`,
    sender:ss[i%5],recipient:rs[i%5],
    amount_eur:(Math.random()*2000+50).toFixed(2),currency:'EUR',
    category:['Utilities','Retail','Transport'][i%3],
    bank:['Unicredit','Fineco','BNL'][i%3],
    timestamp:new Date().toISOString(),
    note:`Payment ref #${Math.floor(Math.random()*900000+100000)}`
  }));
  log('info',`Demo dataset loaded: ${simRows.length} transactions`);
  await signAll();
}

function setSt(id,state){
  const el=document.getElementById(`st-${id}`);
  const labels={pending:'// waiting',running:'↻ processing…',done:'✓ complete',fail:'✗ failed'};
  el.className=`pipe-st ${state}`;el.textContent=labels[state];
}
function setProg(id,pct){const el=document.getElementById(`pr-${id}`);if(el)el.style.width=pct+'%';}
function log(type,msg){
  const el=document.getElementById('live-log');
  const cls={ok:'log-ok',err:'log-err',warn:'log-warn',info:'log-info'}[type]||'log-info';
  const ts=new Date().toLocaleTimeString('it-IT');
  const d=document.createElement('div');
  d.innerHTML=`<span class="log-info">[${ts}]</span> <span class="${cls}">${msg}</span>`;
  el.appendChild(d);el.scrollTop=el.scrollHeight;
  // Remove placeholder
  const ph=el.querySelector('span.log-info');
  if(ph&&ph.textContent.includes('Waiting'))ph.remove();
}
function clearLog(){document.getElementById('live-log').innerHTML='<span class="log-info">// Log cleared</span>';}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

/* ═══════════════════════════════════════════
   MERKLE PANEL
═══════════════════════════════════════════ */
async function refreshMerkle(){
  const status = document.getElementById('merkle-status');
  const rootEl = document.getElementById('merkle-root');
  const leafEl = document.getElementById('merkle-leaf');
  const timeEl = document.getElementById('merkle-time');
  if(!status || !rootEl) return;
  status.textContent = '// loading...';
  try{
    const data = await apiJson('/api/merkle/root?limit=200');
    rootEl.textContent = data.merkle_root || '—';
    leafEl.textContent = String(data.leaf_count || 0);
    timeEl.textContent = data.generated_at || '—';
    status.textContent = '// synced with backend';
  }catch(e){
    status.textContent = `// error: ${e.message}`;
    rootEl.textContent = 'unavailable';
    leafEl.textContent = '—';
    timeEl.textContent = '—';
  }
}

/* ═══════════════════════════════════════════
   MULTI-PARTY PANEL
═══════════════════════════════════════════ */
function mpTxPayload(){
  return {
    tx_id: document.getElementById('mp-txid').value.trim(),
    sender: document.getElementById('mp-sender').value.trim() || 'Alice Rossi',
    recipient: document.getElementById('mp-recipient').value.trim() || 'UniMe Fees',
    amount_eur: parseFloat(document.getElementById('mp-amount').value || '100.0'),
    timestamp: new Date().toISOString(),
    currency: 'EUR'
  };
}
function mpRender(data){
  const status = document.getElementById('mp-status');
  const out = document.getElementById('mp-json');
  if(status) status.textContent = '// chain updated';
  if(out) out.textContent = JSON.stringify(data, null, 2);
}
function mpCurrentTxId(){
  return document.getElementById('mp-txid').value.trim();
}
async function mpInit(){
  const payload = mpTxPayload();
  if(!payload.tx_id){
    document.getElementById('mp-status').textContent='// tx_id is required';
    return;
  }
  document.getElementById('mp-status').textContent='// initializing...';
  try{
    const data = await apiJson('/api/multiparty/init', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({transaction: payload, initiator: 'Alice'})
    });
    mpRender(data);
  }catch(e){
    document.getElementById('mp-status').textContent=`// error: ${e.message}`;
  }
}
async function mpSign(party){
  const txid = mpCurrentTxId();
  if(!txid){
    document.getElementById('mp-status').textContent='// set tx_id first';
    return;
  }
  document.getElementById('mp-status').textContent=`// signing as ${party}...`;
  try{
    const data = await apiJson(`/api/multiparty/sign/${encodeURIComponent(txid)}`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({party})
    });
    mpRender(data);
  }catch(e){
    document.getElementById('mp-status').textContent=`// error: ${e.message}`;
  }
}
async function mpLoad(){
  const txid = mpCurrentTxId();
  if(!txid){
    document.getElementById('mp-status').textContent='// set tx_id first';
    return;
  }
  document.getElementById('mp-status').textContent='// loading status...';
  try{
    const data = await apiJson(`/api/multiparty/${encodeURIComponent(txid)}`);
    mpRender(data);
  }catch(e){
    document.getElementById('mp-status').textContent=`// error: ${e.message}`;
  }
}

// Drag & drop
const dz=document.getElementById('drop-zone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag');});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
dz.addEventListener('drop',e=>{
  e.preventDefault();dz.classList.remove('drag');
  const f=e.dataTransfer.files[0];if(f)handleFile(f);
});

/* ═══════════════════════════════════════════
   INIT
═══════════════════════════════════════════ */
initKey().then(()=>{
  loadOverview().then(()=>{logRows=overviewData;renderLog();});
  refreshMerkle();
});
</script>
</body>
</html>
